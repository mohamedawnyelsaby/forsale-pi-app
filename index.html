<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forsale - سوق Pi المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pi-yellow': '#FFD400',
                        'pi-blue': '#0D1B2A',
                        'pi-dark': '#000000',
                        'pi-light': '#EFEFEF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            background-color: #0D1B2A; /* Pi Blue background */
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1A2E44;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #FFD400;
        }
        .ai-card {
            background-color: #2D3E50;
        }
        .ai-button {
            transition: background-color 0.3s, transform 0.1s;
        }
        .ai-button:hover {
            background-color: #e5c300;
        }
        .ai-button:active {
            transform: scale(0.98);
        }
        .ai-button:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        .product-card {
            transition: transform 0.3s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Header Section -->
    <header class="flex justify-between items-center mb-6">
        <div class="text-3xl font-bold flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFD400" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ml-2">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4v0"></path>
            </svg>
            <!-- تصحيح ترتيب الكلمات لضمان (For=أخضر) ثم (sale=أبيض) حتى في تصميم RTL -->
            <span dir="ltr" class="inline-flex">
                <span class="text-green-400">For</span><span class="text-white">sale</span>
            </span>
        </div>
        <div class="flex items-center space-x-4 space-x-reverse">
            <button onclick="showCart()" class="text-pi-yellow hover:text-white transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
            </button>
            <button onclick="showProfile()" class="text-pi-yellow hover:text-white transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </button>
        </div>
    </header>

    <!-- Auth Status Card -->
    <div class="card p-3 rounded-xl mb-6 text-sm text-white flex flex-col sm:flex-row justify-between items-start sm:items-center">
        <p><strong>حالة الاتصال بـ (Pi/Firebase):</strong> <span id="auth-status" class="text-yellow-400">جاري الاتصال...</span></p>
        <p class="mt-2 sm:mt-0"><strong>معرف المستخدم (User ID):</strong> <span id="user-id" class="break-all text-gray-300 text-xs">...</span></p>
    </div>

    <!-- AI Search Section -->
    <div class="ai-card p-6 rounded-xl mb-8">
        <h2 class="text-2xl font-bold text-center text-pi-yellow mb-2">البحث الذكي (AI Marketplace Agent)</h2>
        <p class="text-center text-white text-opacity-80 mb-4 text-sm">صف ما تحتاجه وسيقوم الذكاء الاصطناعي (عبر محاكاة البحث) باقتراح أفضل صفقة لك مُسعّرة بالـ Pi (Pi Coin).</p>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse">
            <input type="text" id="ai-search-input" placeholder="مثال: هاتف ذكي جديد يدعم 5G" 
                    class="flex-grow p-3 rounded-lg border-2 border-pi-yellow bg-pi-blue text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pi-yellow">
            
            <button onclick="handleAISearch()" id="ai-search-button"
                    class="ai-button bg-pi-yellow text-pi-dark font-bold py-3 px-6 rounded-lg shadow-lg">
                بحث AI
            </button>
        </div>

        <div id="ai-search-result" class="mt-4 p-4 rounded-lg bg-pi-dark text-white text-sm whitespace-pre-wrap hidden">
            <!-- AI Results will be injected here -->
        </div>

        <div id="ai-message" class="mt-4 p-2 rounded-lg bg-red-800 text-white text-xs hidden">
            <!-- Error/Info messages will be injected here -->
        </div>
    </div>
    
    <!-- Products Section -->
    <h2 class="text-3xl font-bold text-white mb-6 mt-10">المنتجات المميزة عالمياً</h2>

    <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Products will be injected here -->
    </div>

    <!-- System Message Modal -->
    <div id="system-message-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="hideSystemMessage()">
        <div class="bg-pi-light p-6 rounded-xl w-full max-w-sm text-center shadow-2xl" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-pi-dark"></h3>
            <p id="modal-content" class="text-gray-700 mb-4"></p>
            <button onclick="hideSystemMessage()" class="bg-pi-yellow hover:bg-yellow-400 text-pi-dark font-bold py-2 px-4 rounded-lg transition duration-200">إغلاق</button>
        </div>
    </div>

    <!-- JavaScript and Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // إعداد Firebase (لا تقم بتعديل هذه المتغيرات الثابتة)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // متغيرات عامة
        let app, db, auth, userId = null;

        // ** بيانات تجريبية (Mock Data) لعرض المنتجات قبل جلب بيانات Firestore **
        const MOCK_PRODUCTS = [
            {
                name: "هاتف Pi الذكي (الجيل الخامس)",
                description: "أحدث هاتف ذكي يدعم شبكات الجيل الخامس (5G) مع كاميرا احترافية وشاشة OLED فائقة الوضوح. متوفر بضمان سنتين.",
                price_in_pi: 85.50,
                image_url: "https://placehold.co/400x300/FFD400/0D1B2A?text=هاتف+5G",
                id: 'mock1'
            },
            {
                name: "ساعة Pi الذكية (إصدار خاص)",
                description: "ساعة ذكية أنيقة بتصميم رياضي، مزودة بمستشعرات للصحة واللياقة البدنية وعمر بطارية يدوم لأسبوع كامل. مقاومة للماء.",
                price_in_pi: 12.75,
                image_url: "https://placehold.co/400x300/0D1B2A/FFD400?text=ساعة+ذكية",
                id: 'mock2'
            },
            {
                name: "جهاز تعدين Pi صغير",
                description: "جهاز صغير وخفيف الوزن، يعمل على تعزيز معدل تعدين Pi الخاص بك. سهل التوصيل عبر USB ولا يحتاج لإعدادات معقدة.",
                price_in_pi: 3.99,
                image_url: "https://placehold.co/400x300/1A2E44/FFD400?text=جهاز+تعدين",
                id: 'mock3'
            },
            {
                name: "كوب قهوة (شعار Pi)",
                description: "كوب سيراميك فاخر يحمل شعار Pi، مثالي لبدء يومك بجرعة من الحماس. سعة 350 مل.",
                price_in_pi: 0.15,
                image_url: "https://placehold.co/400x300/FFD400/0D1B2A?text=كوب+قهوة",
                id: 'mock4'
            }
        ];

        // لتمكين تسجيلات الأخطاء في Firebase (مهم للتطوير)
        setLogLevel('Debug');

        // **************
        // 1. تهيئة Firebase والمصادقة
        // **************
        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // المصادقة باستخدام رمز Pi Custom Auth Token أو تسجيل الدخول كمجهول
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // مراقبة حالة المصادقة وتحديث الواجهة
                onAuthStateChanged(auth, (user) => {
                    const statusEl = document.getElementById('auth-status');
                    const userIdEl = document.getElementById('user-id');
                    
                    if (user) {
                        userId = user.uid;
                        statusEl.textContent = 'متصل (مُصادَق)';
                        statusEl.classList.remove('text-yellow-400', 'text-orange-400');
                        statusEl.classList.add('text-green-400');
                        userIdEl.textContent = userId;

                        // عرض المنتجات التجريبية أولاً لتحسين تجربة المستخدم
                        renderProducts(MOCK_PRODUCTS);

                        // بمجرد المصادقة، ابدأ في جلب البيانات الحقيقية
                        setupProductListener(); 

                    } else {
                        // في حال عدم وجود مصادقة (يجب ألا يحدث مع __initial_auth_token)
                        userId = crypto.randomUUID(); // معرف عشوائي للمجهول
                        statusEl.textContent = 'متصل (مجهول)';
                        statusEl.classList.remove('text-yellow-400', 'text-green-400');
                        statusEl.classList.add('text-orange-400');
                        userIdEl.textContent = userId;
                        
                        // عرض المنتجات التجريبية أولاً لتحسين تجربة المستخدم
                        renderProducts(MOCK_PRODUCTS);

                        setupProductListener();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('auth-status').textContent = 'خطأ في الاتصال';
                document.getElementById('auth-status').classList.add('text-red-500');
            }
        };

        // **************
        // 2. إدارة البيانات: المنتجات (عامة - Read-Only)
        // **************
        function getProductsCollectionPath() {
            // مسار المجموعة العامة المشتركة
            return `/artifacts/${appId}/public/data/products`;
        }

        function setupProductListener() {
            // تأكد من تهيئة قاعدة البيانات قبل البدء
            if (!db) return;
            
            const productsColRef = collection(db, getProductsCollectionPath());
            
            // الاستماع للتغييرات في الوقت الفعلي
            onSnapshot(productsColRef, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                // تحديث المنتجات بالبيانات الحقيقية إذا كانت موجودة
                if (products.length > 0) {
                    renderProducts(products);
                } else if (document.getElementById('products-grid').children.length === 0) {
                    // إذا لم يتم عرض أي شيء على الشاشة، اعرض رسالة عدم وجود منتجات
                    // هذا يحمي من مسح المنتجات التجريبية إذا كان جلب Firestore بطيئًا
                     document.getElementById('products-grid').innerHTML = '<p class="text-white text-center col-span-full">لا توجد منتجات متاحة حالياً في قاعدة البيانات. يتم عرض البيانات التجريبية تلقائياً عند التحميل.</p>';
                }

            }, (error) => {
                console.error("Error fetching products:", error);
                showSystemMessage("خطأ في قاعدة البيانات", "فشل جلب المنتجات من Firestore. يرجى التحقق من القواعد.", "error");
            });
        }

        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = ''; // مسح المحتوى القديم

            if (products.length === 0) {
                grid.innerHTML = '<p class="text-white text-center col-span-full">لا توجد منتجات متاحة حالياً.</p>';
                return;
            }

            products.forEach(product => {
                const priceInPi = product.price_in_pi || 'N/A';
                const html = `
                    <div class="product-card card p-4 rounded-xl flex flex-col justify-between">
                        <div>
                            <img src="${product.image_url || 'https://placehold.co/400x300/1A2E44/FFFFFF?text=صورة+المنتج'}" 
                                    onerror="this.onerror=null;this.src='https://placehold.co/400x300/1A2E44/FFFFFF?text=صورة+المنتج';"
                                    alt="${product.name}" class="rounded-lg mb-4 w-full h-48 object-cover">
                            <h3 class="text-lg font-semibold text-white mb-2">${product.name}</h3>
                            <p class="text-gray-400 text-sm mb-4 line-clamp-3">${product.description}</p>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-xl font-bold text-pi-yellow">${priceInPi} Pi</span>
                            <button onclick="mockBuy('${product.name}', ${priceInPi})"
                                    class="bg-pi-yellow text-pi-dark font-semibold py-2 px-4 rounded-lg hover:bg-yellow-400 transition duration-200">
                                شراء
                            </button>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', html);
            });
        }

        // **************
        // 3. محاكاة الشراء (Pi Payments Mock)
        // **************
        window.mockBuy = (productName, price) => {
            showSystemMessage("محاكاة عملية الشراء", `جارٍ تحويل ${price} Pi لشراء ${productName}. يجب هنا أن يتم فتح Pi Payments SDK.`, "info");
            // هنا يجب أن يتم استدعاء Pi Payments SDK (خارج نطاق هذا الملف لبيئة الاختبار)
            // Pi.createPayment(...)
        }

        // **************
        // 4. وظائف واجهة المستخدم (Modal)
        // **************
        window.showSystemMessage = (title, content, type = "info") => {
            const modal = document.getElementById('system-message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            
            const titleEl = document.getElementById('modal-title');
            titleEl.classList.remove('text-red-600', 'text-green-600', 'text-pi-dark');
            
            if (type === 'error') {
                titleEl.classList.add('text-red-600');
            } else if (type === 'success') {
                titleEl.classList.add('text-green-600');
            } else {
                 titleEl.classList.add('text-pi-dark');
            }
            
            modal.classList.remove('hidden');
        }

        window.hideSystemMessage = () => {
            document.getElementById('system-message-modal').classList.add('hidden');
        }
        
        // **************
        // 6. دوال أخرى للواجهة (يمكن إضافتها هنا)
        // **************
        window.showCart = () => { showSystemMessage("عربة التسوق", "هنا سيتم عرض المنتجات التي اخترتها للدفع عبر Pi."); }
        window.showProfile = () => { showSystemMessage("ملفي الشخصي", "هنا ستعرض معلومات ملفك الشخصي وعمليات الشراء السابقة."); }

        // ***********************************************************************************
        // ***********************************************************************************
        // ** 5. وظيفة البحث الذكي (Gemini API) - تم نقلها إلى نهاية الكود لسهولة الوصول للمفتاح **
        // ***********************************************************************************
        // ***********************************************************************************
        
        let isSearchButtonEnabled = true; // متغير للتحكم في حالة الزر (Rate Limiting)
        const RATE_LIMIT_MS = 5000; // 5 ثوانٍ كحد أدنى بين الطلبات (للحماية من الاستخدام المفرط)

        window.handleAISearch = async () => {
            const query = document.getElementById('ai-search-input').value.trim();
            const resultDiv = document.getElementById('ai-search-result');
            const button = document.getElementById('ai-search-button');
            const messageDiv = document.getElementById('ai-message');
            
            // تحقق من قيد معدل الطلبات
            if (!isSearchButtonEnabled) {
                messageDiv.textContent = "الرجاء الانتظار 5 ثوانٍ قبل البحث مرة أخرى لحماية المفتاح.";
                messageDiv.classList.remove('hidden', 'bg-red-800');
                messageDiv.classList.add('bg-yellow-700');
                return;
            }

            if (!query) {
                resultDiv.classList.add('hidden');
                messageDiv.textContent = "الرجاء إدخال استعلام للبحث.";
                messageDiv.classList.remove('hidden', 'bg-yellow-700');
                messageDiv.classList.add('bg-red-800');
                return;
            }

            // =================================================================================
            // ** الخطوة الأخيرة والمباشرة لإضافة مفتاح الـ API **
            // يرجى لصق مفتاحك هنا داخل علامات التنصيص:
            const apiKey = "AIzaSyAWsT-u3O3ZCp7m_fUsELlHjIMYA202zx0"; // <--- الصق مفتاح Gemini API هنا
            // =================================================================================
            
            if (!apiKey) {
                resultDiv.classList.add('hidden');
                messageDiv.textContent = "فشل البحث الذكي. المفتاح غير متوفر. يرجى لصق مفتاح Gemini API المؤمَّن.";
                messageDiv.classList.remove('hidden', 'bg-yellow-700');
                messageDiv.classList.add('bg-red-800');
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `أنت خبير تسوق على شبكة Pi، مهمتك هي تحليل طلب المستخدم وتقديم نصيحة تسويقية مفصلة أو قائمة منتجات مقترحة. يجب أن تكون الإجابة بتنسيق Markdown. لا تتجاوز 150 كلمة. لا تستخدم علامات ترقيم (مثل علامات النجمة).`;
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // تفعيل قيد معدل الطلبات
            isSearchButtonEnabled = false;
            button.disabled = true;
            button.textContent = 'جاري البحث...';
            messageDiv.classList.add('hidden');
            resultDiv.textContent = 'جاري البحث عن نتائج في الويب...';
            resultDiv.classList.remove('hidden');

            try {
                // محاكاة لعملية البحث مع Gemini
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // هنا يجب التعامل مع الأخطاء (مثل 403 Forbidden لو المفتاح غير صحيح أو غير مُقيّد)
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "لم يتم العثور على نتائج ذات صلة.";
                
                // تنظيف وإزالة علامات النجمة التي قد تتسبب في مشاكل تنسيق غير مرغوب فيها
                const cleanText = text.replace(/\*/g, '').trim(); 
                
                resultDiv.textContent = cleanText;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                const apiKey = "AIzaSyAWsT-u3O3ZCp7m_fUsELlHjIMYA202zx0";
                resultDiv.textContent = `حدث خطأ في الاتصال بالذكاء الاصطناعي: ${error.message}. إذا كان الخطأ 403، يرجى التحقق من المفتاح أو تقييد الموقع في Google Cloud.`;
                resultDiv.classList.remove('hidden');
            } finally {
                // تعطيل الزر مؤقتاً لقيد معدل الطلبات
                setTimeout(() => {
                    isSearchButtonEnabled = true;
                    button.disabled = false;
                    button.textContent = 'بحث AI';
                    messageDiv.classList.add('hidden');
                }, RATE_LIMIT_MS);
            }
        };
    </script>
</body>
</html>
