<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Forsale â€” AI Global Marketplace</title>
    <meta name="application-name" content="Forsale - AI Global Marketplace" />
    <meta name="description" content="Forsale â€” AI-first marketplace. Buy & sell anything with end-to-end AI automation. Powered by Pi Network AI (Testnet sim included)." />
    <meta name="developer" content="Mohamed Awny (Blackstyle)" />
    <meta name="email" content="mohamed.awny.00000@gmail.com" />
    <meta name="pi-username" content="Blackstyle" />
    <meta name="version" content="1.1.5" />
    <meta name="release-year" content="2025" />
    <meta name="powered-by" content="Pi Network AI" />
    <meta name="deployment" content="Auto Testnet â†’ Mainnet (simulated)" />
    <meta name="customiz-verification" content="3ed6a43fb97d4f88f297e603916dce7c121d9e4ccdcc712649bc56578129510a2ef43c060d87a8f9c9ab878098be9dfa7409ca3b66c25d7d710bf10bccbb8c19">
    <meta name="customiz-allowed-hosts" content="localhost,127.0.0.1,customiz.app,forsale.pi,pi.network">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All CSS from original file */
        :root{
            --pi-yellow:#FFD400;
            --accent-green:#00FF7F;
            --bg-1:#04090c;
            --bg-2:#07121a;
            --card:#0B2130;
            --muted:#9CA3AF;
            --text:#FFFFFF;
            --radius:12px;
            --maxw:1100px;
            --shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-2),var(--bg-1));color:var(--text);-webkit-font-smoothing:antialiased;font-family:Inter, system-ui, 'Cairo', sans-serif; font-size:16px}
        body{padding:0;-webkit-text-size-adjust:100%}
        .wrap{max-width:var(--maxw);margin:0 auto;padding:12px}
        
        /* Top Bar Styling */
        header.topbar{position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:0 0 12px 12px;background:var(--bg-2);border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow);backdrop-filter: blur(6px);margin-bottom:10px}
        .brand{display:flex;align-items:center;gap:12px}
        .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--pi-yellow),var(--accent-green));display:grid;place-items:center;color:#0D1B2A;font-weight:900;font-size:26px}
        .brand-title{font-weight:900;font-size:21px}
        .brand-sub{color:var(--muted);font-size:13px;margin-top:4px}
        .controls{display:flex;gap:8px;align-items:center}
        
        /* Button Styling */
        .btn{background:var(--pi-yellow);color:#0D1B2A;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;transition:background .2s}
        .btn:hover:not([disabled]){filter:brightness(0.9)}
        .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;transition:border-color .2s}
        .ghost:hover:not([disabled]){border-color:var(--pi-yellow)}
        .ghost[disabled], .btn[disabled]{opacity:0.5;cursor:not-allowed}
        
        /* Layout Structure */
        .content{display:flex;gap:14px}
        @media(max-width:980px){ .content{flex-direction:column} }
        .left{flex:1}
        .right{width:360px}
        @media(max-width:780px){ .right{width:100%} }
        
        /* Card Styling */
        .card{background:linear-gradient(180deg,var(--card), #05131a);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
        /* Category Scroll */
        .cats{display:flex;gap:10px;overflow-x:auto;padding:8px 6px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
        .cat{flex:0 0 auto;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);min-width:110px;cursor:pointer;font-size:14px;transition:all .15s}
        .cat:hover{background:rgba(255,255,255,0.05);}
        .cat.active{border-color:var(--pi-yellow);box-shadow:0 6px 18px rgba(255,212,0,0.08);background:rgba(255,212,0,0.1);}
        
        /* Search Bar */
        .search-row{display:flex;gap:8px;align-items:center;margin-top:12px}
        .search-row input{flex:1;padding:12px;border-radius:10px;background:transparent;color:var(--text);outline:none;border:2px solid transparent;box-shadow:0 0 5px rgba(255,212,0,0.12);font-size:16px;transition:border-color .2s}
        .search-row input:focus{border-color:var(--pi-yellow)}
        .mic{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--pi-yellow);cursor:pointer;transition:background .2s}
        .mic:hover{background:rgba(255,255,255,0.05);}
        
        /* Product Grid */
        .products{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:14px}
        @media(max-width:720px){ .products{grid-template-columns:repeat(1,1fr)} }
        .product{border-radius:12px;padding:12px;background:linear-gradient(180deg,#0d2a35,#07121a);border:1px solid rgba(255,255,255,0.02);transition:transform .18s;cursor:pointer}
        .product:hover{transform:translateY(-6px)}
        .product img{width:100%;height:140px;object-fit:cover;border-radius:10px}
        .product .title{font-weight:900;margin-top:8px;line-height:1.3}
        .product .desc{color:var(--muted);margin-top:6px;line-height:1.4}
        .price{font-weight:900;color:var(--pi-yellow)}
        
        /* Sort Control */
        .sort-row{display:flex;align-items:center;justify-content:space-between;margin-top:14px;margin-bottom:14px;font-size:15px}
        .sort-control select{background:var(--card);color:var(--text);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);appearance:none;cursor:pointer}
        
        /* Modals */
        .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:200;visibility:hidden;opacity:0;transition:opacity .18s,visibility .18s}
        .modal.show{visibility:visible;opacity:1}
        .modal .box{background:#0b1518;color:var(--text);padding:16px;border-radius:12px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.6);transform:scale(0.95);transition:transform .2s;
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
        }
        .modal.show .box{transform:scale(1)}
        
        .modal-content-scrollable {
            overflow-y: auto; 
            flex-grow: 1; 
        }
        .modal-img-container {
            width: 100%;
            max-height: 220px; 
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .modal img{width:100%;height:100%;object-fit:cover;border-radius:0;margin-bottom:0}
        .modal-actions-sticky {
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.04);
            display: flex;
            gap: 10px;
            justify-content: space-between;
            flex-shrink: 0; 
        }
        .modal-actions-sticky .btn, .modal-actions-sticky .ghost {
            flex: 1; 
            font-size: 15px;
            padding: 10px 12px;
        }
        
        /* Chat Styling */
        .chat-body{max-height:360px;overflow:auto;padding:8px;border-radius:8px;margin-bottom:8px;display:flex;flex-direction:column}
        .chat-bubble{max-width:85%;padding:10px 14px;border-radius:16px;margin-bottom:8px;font-size:15px;line-height:1.4;word-wrap:break-word;}
        .chat-bubble.user{background:var(--pi-yellow);color:#07121a;margin-left:auto;border-bottom-left-radius:4px;}
        .chat-bubble.ai{background:#20313a;color:#fff;margin-right:auto;border-bottom-right-radius:4px;}
        .chat-controls{display:flex;gap:8px;margin-top:8px}
        .chat-send-btn{background:#00FF7F;color:#0D1B2A;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
        .chat-controls input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:16px}
        
        /* Log Panel */
        .log{max-height:220px;overflow:auto;padding:10px;background:#06121a;border-radius:8px;color:var(--muted);font-size:14px}
        
        /* Footer */
        footer{margin-top:20px;padding:18px 0;text-align:center;color:var(--muted);font-size:14px}
        
        /* RTL & Responsiveness adjustments */
        [dir="rtl"] #mainTitle { font-size:22px }
        [dir="rtl"] #mainSub { font-size:15px;color:var(--muted)}
        @media(max-width:420px){
            .logo{width:56px;height:56px;font-size:22px}
            header.topbar{padding:8px}
        }
        
        /* Adjust modal content layout */
        .modal .product-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal .product-info {
            flex: 1;
        }
        
        .modal .product-price {
            font-weight: 900;
            color: var(--pi-yellow);
            font-size: 24px;
            margin-top: 8px;
        }
        
        /* Additional fixes */
        .cart-qty-btn, .cart-remove-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.06);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .cart-qty-btn:hover, .cart-remove-btn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div id="verificationBanner" style="margin-bottom:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--muted)" data-ar="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚..." data-en="Verifying...">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</div>
        
        <header class="topbar" role="banner" aria-label="Header">
            <div class="brand" style="gap:10px">
                <div class="logo" aria-hidden="true">F</div>
                <div>
                    <div class="brand-title" id="brandTitle">Forsale</div>
                    <div class="brand-sub" id="brandSub" data-ar="AI Smart Marketplace â€¢ Global-ready" data-en="AI Smart Marketplace â€¢ Global-ready">AI Smart Marketplace â€¢ Global-ready</div>
                </div>
            </div>
            
            <div class="controls" role="navigation" aria-label="Controls">
                <button id="langToggleTop" class="ghost" title="Toggle language">EN</button>
                <button id="connectBtn" class="ghost" title="Connect to Pi" data-ar="Ø§ØªØµØ§Ù„" data-en="Connect">Connect</button>
                <button id="netBtn" class="ghost" title="Toggle network">Testnet</button>
            </div>
        </header>
        
        <div class="content">
            <div class="left">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <h2 id="mainTitle" style="margin:0" data-ar="Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠ" data-en="AI Smart Marketplace">Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠ</h2>
                            <div id="mainSub" class="muted" data-ar="Ù…Ù† Ø§Ù„Ø§ÙƒØªØ´Ø§Ù Ø­ØªÙ‰ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… â€” Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" data-en="From discovery to delivery â€” fully AI-powered">Ù…Ù† Ø§Ù„Ø§ÙƒØªØ´Ø§Ù Ø­ØªÙ‰ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… â€” Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
                        </div>
                        <div id="userInfo" class="muted" style="text-align:right">
                            <div class="username-text" data-ar="ØºÙŠØ± Ù…ØªØµÙ„" data-en="Disconnected">ØºÙŠØ± Ù…ØªØµÙ„</div>
                            <div class="balance-text muted"></div>
                        </div>
                    </div>
                    
                    <div class="cats" id="cats" aria-label="Categories" style="margin-top:12px"></div>
                    
                    <div class="search-row">
                        <input id="search" data-ar="Ø§Ø¨Ø­Ø«: Ù…Ø«Ø§Ù„ 'ØªÙˆÙŠÙˆØªØ§' Ø£Ùˆ 'Ù‡Ø§ØªÙ'" data-en="Search: e.g. 'Toyota' or 'phone'" placeholder="Ø§Ø¨Ø­Ø«: Ù…Ø«Ø§Ù„ 'ØªÙˆÙŠÙˆØªØ§' Ø£Ùˆ 'Ù‡Ø§ØªÙ'">
                        <button id="voiceSearchBtn" class="mic" title="Ø¨Ø­Ø« ØµÙˆØªÙŠ">ğŸ™ï¸</button>
                    </div>
                    
                    <div class="sort-row">
                        <div style="display:flex;align-items:center">
                            <div id="sortLabel" style="font-weight:700;margin-right:12px" data-ar="ÙØ±Ø² Ø­Ø³Ø¨:" data-en="Sort by:">ÙØ±Ø² Ø­Ø³Ø¨:</div>
                            <div class="sort-control">
                                <select id="sortSelect">
                                    <option value="default" data-ar="Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø«)" data-en="Default (Latest)">Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                                    <option value="rating_desc" data-ar="Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹" data-en="Top Rated">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
                                    <option value="price_asc" data-ar="Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹" data-en="Lowest Price">Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹</option>
                                    <option value="price_desc" data-ar="Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹" data-en="Highest Price">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹</option>
                                </select>
                            </div>
                        </div>
                        <button id="logyBtn" title="Ø§Ø³Ø£Ù„ Logy: ØªÙˆØµÙŠØ© AI" data-ar="ğŸ¤– Ø§Ø³Ø£Ù„ Logy" data-en="ğŸ¤– Ask Logy">ğŸ¤– Ø§Ø³Ø£Ù„ Logy</button>
                    </div>
                    
                    <div id="productList" class="products" aria-live="polite"></div>
                </div>
                
                <div style="margin-top:14px" class="card">
                    <h3 style="margin:0" data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«" data-en="Transaction Log">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div id="txLog" class="log" style="margin-top:10px"></div>
                    </div>
                    
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                        <button id="clearLogs" class="ghost" data-ar="ØªÙØ±ÙŠØº" data-en="Clear">ØªÙØ±ÙŠØº</button>
                        <button id="exportBtn" class="ghost" data-ar="ØªØµØ¯ÙŠØ±" data-en="Export" disabled>ØªØµØ¯ÙŠØ±</button>
                    </div>
                </div>
            </div>
            
            <div class="right">
                <div class="card">
                    <h3 id="cartTitle" style="margin:0" data-ar="Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚" data-en="Shopping Cart">Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h3>
                    <div id="cartArea" style="margin-top:12px"></div>
                    
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
                        <div class="muted" id="cartTotal" data-ar="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:" data-en="Total:">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Pi</div>
                        <div><button id="checkoutBtn" class="btn" disabled data-ar="Ø¯ÙØ¹ (Testnet)" data-en="Pay (Testnet)">Ø¯ÙØ¹ (Testnet)</button></div>
                    </div>
                    
                    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin-top:12px">
                    <div class="muted" style="font-weight:700;" data-ar="ØªØ­Ù„ÙŠÙ„Ø§Øª AI" data-en="AI Analytics">ØªØ­Ù„ÙŠÙ„Ø§Øª AI</div>
                    <div id="aiPanel" style="margin-top:8px" class="muted">
                         <span class="ai-intent" data-ar="Ù†ÙˆØ§ÙŠØ§: â€”" data-en="Intent: â€”">Ù†ÙˆØ§ÙŠØ§: â€”</span><br>
                         <span class="ai-rec" data-ar="ØªÙˆØµÙŠØ©: â€”" data-en="Recommendation: â€”">ØªÙˆØµÙŠØ©: â€”</span>
                    </div>
                </div>
                
                <div style="margin-top:12px" class="card">
                    <h3 style="margin:0" data-ar="Ø§Ù„Ù…Ø·ÙˆØ±" data-en="Developer">Ø§Ù„Ù…Ø·ÙˆØ±</h3>
                    <div class="muted" style="margin-top:8px">
                        Mohamed Awny (Blackstyle)<br>mohamed.awny.00000@gmail.com
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div style="font-weight:800">Forsale</div>
            <div class="muted">Forsale â€” Powered by Pi Network AI</div>
        </footer>
    </div>
    
    <div class="modal" id="productModal" aria-hidden="true">
        <div class="box" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:900" id="modalTitle" data-ar="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬" data-en="Product Details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>
                <div><button id="closeModal" class="ghost" data-ar="Ø¥ØºÙ„Ø§Ù‚" data-en="Close">Ø¥ØºÙ„Ø§Ù‚</button></div>
            </div>
            
            <div class="modal-content-scrollable">
                <div class="modal-img-container">
                    <img id="modalImg" src="" alt="">
                </div>
                <div class="product-details">
                    <div class="product-info">
                        <div style="font-weight:900" id="modalName"></div>
                        <div class="muted" id="modalDesc" style="margin-top:6px"></div>
                        <div class="product-price" id="modalPrice"></div>
                        <div style="margin-top:16px" class="muted">
                            <p>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: <span id="modalExtra">...</span></p>
                        </div>
                    </div>
                </div>
            </div> 
            <div class="modal-actions-sticky">
                <button id="modalAdd" class="btn" data-ar="Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©" data-en="Add to Cart">Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©</button>
                <button id="modalChat" class="ghost" data-ar="ØªØ­Ø¯Ø« Ù…Ø¹ Logy" data-en="Chat with Logy">ØªØ­Ø¯Ø« Ù…Ø¹ Logy</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="logyModal" aria-hidden="true">
        <div class="box" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:900" data-ar="Logy â€” Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" data-en="Logy â€” AI Assistant">Logy â€” Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
                <div><button id="closeLogy" class="ghost" data-ar="Ø¥ØºÙ„Ø§Ù‚" data-en="Close">Ø¥ØºÙ„Ø§Ù‚</button></div>
            </div>
            <div id="logyBody" class="chat-body"><div class="chat-bubble ai initial-ai-msg" data-ar="Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† ØªÙˆØµÙŠØ§Øª Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø©." data-en="Hello! Ask me for recommendations or help.">Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† ØªÙˆØµÙŠØ§Øª Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø©.</div></div>
            <div class="chat-controls">
                <input id="logyInput" data-ar="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." data-en="Type your question..." placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." />
                <button id="logySend" class="chat-send-btn" data-ar="Ø§Ø±Ø³Ø§Ù„" data-en="Send">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
            <div style="margin-top:8px"><small class="muted"><span class="log-label" data-ar="Ø³Ø¬Ù„:" data-en="Log:">Ø³Ø¬Ù„:</span> <span id="logyStatus" data-ar="Ø¬Ø§Ù‡Ø²" data-en="Ready">Ø¬Ø§Ù‡Ø²</span></small></div>
        </div>
    </div>
    
    <div id="toast" style="position:fixed;left:12px;top:12px;background:var(--accent-green);color:#031617;padding:8px 12px;border-radius:8px;display:none;z-index:999">Ready</div>
    
<script>
/* Full frontend implementation (self-contained).
  - Includes full Cart logic, Pi SDK simulation, and AI chat mock-up.
  - FIXED: Dynamic language switching without page reload.
  - FIXED: Added modal buttons for Add/Chat and fixed modal image sizing.
*/
(function(){

    'use strict';

    // -------------------------
    // Data (Product & Categories)
    // -------------------------

    const TRANSLATIONS = {
        'connectBtn': {ar: 'Ø§ØªØµØ§Ù„', en: 'Connect'},
        'netBtnMain': {ar: 'Mainnet', en: 'Mainnet'},
        'netBtnTest': {ar: 'Testnet', en: 'Testnet'},
        'disconnected': {ar: 'ØºÙŠØ± Ù…ØªØµÙ„', en: 'Disconnected'},
        'total': {ar: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', en: 'Total'},
        'pay': {ar: 'Ø¯ÙØ¹', en: 'Pay'},
        'add_to_cart': {ar: 'Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©', en: 'Add to Cart'},
        'chat_with_logy': {ar: 'ØªØ­Ø¯Ø« Ù…Ø¹ Logy', en: 'Chat with Logy'},
    };

    const CATEGORIES = [
        {key:'all', icon:'fa-th-large', ar:'Ø§Ù„ÙƒÙ„', en:'All'},
        {key:'cars', icon:'fa-car-side', ar:'Ø³ÙŠØ§Ø±Ø§Øª', en:'Cars'},
        {key:'real', icon:'fa-building', ar:'Ø¹Ù‚Ø§Ø±Ø§Øª', en:'Real Estate'},
        {key:'electronics', icon:'fa-microchip', ar:'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', en:'Electronics'},
        {key:'fashion', icon:'fa-tshirt', ar:'Ø£Ø²ÙŠØ§Ø¡', en:'Fashion'},
        {key:'home', icon:'fa-house-chimney', ar:'Ù…Ù†Ø²Ù„', en:'Home'},
        {key:'services', icon:'fa-hands', ar:'Ø®Ø¯Ù…Ø§Øª', en:'Services'}
    ];


    const PRODUCTS = [
        {id:'p1',cat:'cars', name_ar:'ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§ 2018', name_en:'Toyota Corolla 2018', desc_ar:'Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø© â€¢ 120 Ø£Ù„Ù ÙƒÙ…', desc_en:'Excellent â€¢ 120k km', price:120000, img:'https://placehold.co/800x600/FFD400/0D1B2A?text=Corolla', rating:4.3, created:'2025-01-10'},
        {id:'p2',cat:'electronics', name_ar:'Ù‡Ø§ØªÙ Pi Ø§Ù„Ø°ÙƒÙŠ', name_en:'Pi Smart Phone', desc_ar:'5G â€¢ Ø´Ø§Ø´Ø© OLED â€¢ ÙƒØ§Ù…ÙŠØ±Ø§ AI', desc_en:'5G â€¢ OLED â€¢ AI Camera', price:85.5, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Phone', rating:4.7, created:'2025-02-04'},
        {id:'p3',cat:'electronics', name_ar:'Ø³Ø§Ø¹Ø© Pi', name_en:'Pi Smart Watch', desc_ar:'Ù„ÙŠØ§Ù‚Ø© â€¢ 7 Ø£ÙŠØ§Ù… Ø¨Ø·Ø§Ø±ÙŠØ©', desc_en:'Fitness â€¢ 7-day battery', price:12.75, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Watch', rating:4.1, created:'2025-03-01'},
        {id:'p4',cat:'real', name_ar:'Ø´Ù‚Ø© 120Ù… Ø¨Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ', name_en:'120m Apartment in Zamalek', desc_ar:'Ù…ÙØ±ÙˆØ´Ø© â€¢ Ù…ÙˆÙ‚Ø¹ Ù…Ù…ÙŠØ²', desc_en:'Furnished â€¢ Prime location', price:21000, img:'https://placehold.co/800x600/08121a/FFD400?text=Apartment', rating:4.6, created:'2025-01-20'},
        {id:'p5',cat:'fashion', name_ar:'Ø¬Ø§ÙƒÙŠØª Ø¬Ù„Ø¯', name_en:'Leather Jacket', desc_ar:'Ø¬Ù„Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ â€¢ Ø¬Ø¯ÙŠØ¯', desc_en:'Genuine leather â€¢ New', price:120, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Jacket', rating:4.0, created:'2025-04-10'},
        {id:'p6',cat:'home', name_ar:'Ø·Ù‚Ù… ÙƒÙ†Ø¨Ø© 3 Ù…Ù‚Ø§Ø¹Ø¯', name_en:'3-Seater Sofa Set', desc_ar:'Ù‚Ù…Ø§Ø´ ÙØ§Ø®Ø± â€¢ Ø¶Ù…Ø§Ù† Ø³Ù†Ø©', desc_en:'Premium fabric â€¢ 1yr warranty', price:450, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Sofa', rating:4.2, created:'2025-03-18'}
    ];

    // -------------------------
    // State Management
    // -------------------------

    const state = {
        lang: localStorage.getItem('forsale_lang') || 'ar',
        session: localStorage.getItem('forsale_session') || Date.now().toString(36),
        user: null,
        cart: JSON.parse(localStorage.getItem('forsale_cart') || '{}'),
        logs: JSON.parse(localStorage.getItem('forsale_logs') || '[]'),
        mainnet: false, // Starts on Testnet simulation
        piLoaded: false, 
        pi: null // Pi SDK instance
    };

    localStorage.setItem('forsale_session', state.session);

    // -------------------------
    // Utility Helpers
    // -------------------------

    const $ = id => document.getElementById(id);

    function toast(msg, t=1500){ 
        const el = $('toast'); 
        if(!el) return; 
        el.textContent = msg; 
        el.style.display='block'; 
        setTimeout(()=>el.style.display='none', t); 
    }

    function pageLog(text, level='info'){
        const ts = new Date().toLocaleTimeString();
        const row = {ts,text,level};
        state.logs.push(row);
        try{ localStorage.setItem('forsale_logs', JSON.stringify(state.logs)); }catch(e){}
        const el = $('txLog'); 
        if(!el) return;

        const div = document.createElement('div');
        // Apply style based on log level
        div.innerHTML = `<small style="color:${level==='error'?'#FF6B6B': level === 'info' ? '#00FF7F' : '#9CA3AF'}">${ts}</small> ${text}`;
        el.prepend(div);
        
        // Keep log tidy
        while(el.children.length > 80) el.removeChild(el.lastChild);
    }
    
    // -------------------------
    // Language Translation Logic (UPDATED)
    // -------------------------

    function getTranslation(el, lang, key) {
        if (key) {
            return TRANSLATIONS[key]?.[lang] || el?.textContent || '';
        }
        return el.getAttribute(`data-${lang}`) || el.textContent;
    }

    function translatePage() {
        const lang = state.lang;
        const isRTL = lang === 'ar';
        
        // 1. Update HTML/Body properties (direction and lang attribute)
        document.documentElement.setAttribute('lang', lang);
        document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
        
        // 2. Update all static elements with data-ar/data-en attributes
        document.querySelectorAll('[data-ar], [data-en]').forEach(el => {
            const translation = getTranslation(el, lang);
            if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                el.setAttribute('placeholder', translation);
            } else if (el.tagName === 'OPTION') {
                el.textContent = translation;
            } else if (el.tagName === 'BUTTON' || el.tagName === 'DIV' || el.tagName === 'H2' || el.tagName === 'H3' || el.tagName === 'SPAN' || el.id === 'verificationBanner') {
                 // Check if it's the connect button and user is logged in
                 if (el.id === 'connectBtn' && state.user) {
                     // Do nothing, keep username
                 } else {
                     el.textContent = translation;
                 }
            }
        });

        // 3. Update special elements based on state/context
        $('langToggleTop').textContent = isRTL ? 'EN' : 'AR';
        
        // Update Connect Button text (if disconnected)
        if (!state.user) {
            $('connectBtn').textContent = getTranslation(null, lang, 'connectBtn');
            $('userInfo').querySelector('.username-text').textContent = getTranslation(null, lang, 'disconnected');
        }
        
        // Update Network Button text
        $('netBtn').textContent = state.mainnet ? getTranslation(null, lang, 'netBtnMain') : getTranslation(null, lang, 'netBtnTest');
        
        // Update the initial AI welcome message
        const initialMsgEl = document.querySelector('.initial-ai-msg');
        if (initialMsgEl) {
             initialMsgEl.textContent = getTranslation(initialMsgEl, lang);
        }

        // Update the log label in the Logy Modal
        const logLabelEl = document.querySelector('.log-label');
        if (logLabelEl) {
             logLabelEl.textContent = getTranslation(logLabelEl, lang);
        }

        // Update dynamic components that need re-rendering
        renderCategories();
        renderProducts($('cats')?.querySelector('.cat.active')?.dataset.cat || 'all', $('sortSelect')?.value || 'default');
        renderCart();
        updateCartTotal();
    }

    // -------------------------
    // Render Functions (Categories & Products)
    // -------------------------

    function renderCategories(){
        const wrap = $('cats');
        if(!wrap) return;

        // Save active category before clearing
        const activeCat = wrap.querySelector('.cat.active')?.dataset.cat || 'all';

        wrap.innerHTML = '';

        CATEGORIES.forEach(c => {
            const d = document.createElement('div');
            d.className = 'cat' + (c.key === activeCat ? ' active' : '');
            d.dataset.cat = c.key;
            d.innerHTML = `<i class="fa-solid ${c.icon}"></i> <span>${state.lang==='ar'?c.ar:c.en}</span>`;

            d.addEventListener('click', () => {
                wrap.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
                d.classList.add('active');
                // Render products based on new category and current sort
                renderProducts(c.key, $('sortSelect')?.value || 'default');
            });
            wrap.appendChild(d);
        });

    }

    function renderProducts(category='all', sort='default'){
        const root = $('productList');
        if(!root) return;

        let list = PRODUCTS.slice();

        if(category !== 'all') list = list.filter(p => p.cat === category);

        // Sort logic
        list.sort((a,b)=>{
            if(sort==='rating_desc') return b.rating - a.rating;
            if(sort==='price_asc') return a.price - b.price;
            if(sort==='price_desc') return b.price - a.price;
            return new Date(b.created) - new Date(a.created); // Default: Latest first
        });

        root.innerHTML = '';

        list.forEach(p=>{
            const title = p['name_' + state.lang];
            const desc = p['desc_' + state.lang];
            const el = document.createElement('div');
            el.className = 'product';
            el.dataset.id = p.id;
            el.innerHTML = `<img src="${p.img}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/800x600/1A2E44/FFFFFF?text=${state.lang==='ar'?'Ø®Ø·Ø£ ØµÙˆØ±Ø©':'Image+Error'}';">
                <div class="title">${title}</div>
                <div class="desc">${desc}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <div class="price">${p.price} Pi</div>
                    <small class="muted"><i class="fa-solid fa-star" style="color:#FFD400"></i> ${p.rating}</small>
                </div>`;

            // click -> open modal
            el.addEventListener('click', () => openProductModal(p.id));
            root.appendChild(el);
        });

    }

    function openProductModal(id){
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) return;

        $('modalImg').src = p.img;
        $('modalImg').onerror = function(){ this.onerror=null;this.src=`https://placehold.co/800x600/1A2E44/FFFFFF?text=${state.lang==='ar'?'Ø®Ø·Ø£ ØµÙˆØ±Ø©':'Image+Error'}`; }

        $('modalName').textContent = p['name_' + state.lang];
        
        // Translate rating label within description
        const ratingLabel = state.lang === 'ar' ? 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' : 'Rating';
        $('modalDesc').textContent = p['desc_' + state.lang] + ` | ${ratingLabel}: ${p.rating}`;

        $('modalPrice').textContent = p.price + ' Pi';

        $('productModal').classList.add('show');

        // set add handler (replace previous)
        const addBtn = $('modalAdd');
        addBtn.onclick = () => { addToCart(p.id); $('productModal').classList.remove('show'); };
        
        // Open Logy chat directly
        $('modalChat').onclick = () => { 
            $('productModal').classList.remove('show'); 
            $('logyModal').classList.add('show'); 
            pageLog(`${state.lang === 'ar' ? 'Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'Started chat about product'}: ${p['name_' + state.lang]}`);
        };

    }

    // -------------------------
    // Cart Functions 
    // -------------------------

    function saveCart(){
        localStorage.setItem('forsale_cart', JSON.stringify(state.cart));
        updateCartTotal();
    }

    function addToCart(id, qty=1){
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) return;
        if(!state.cart[id]) state.cart[id] = {...p, qty:0};
        state.cart[id].qty += qty;
        saveCart();
        pageLog(`${state.lang === 'ar' ? 'Ø£Ø¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©' : 'Added to Cart'}: ${p['name_' + state.lang]} (x${state.cart[id].qty})`);
        renderCart(); 
        toast(state.lang === 'ar' ? 'Ø£Ø¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©!' : 'Added to cart!', 1500);
    }

    function renderCart(){
        const root = $('cartArea');
        // Filter out items with quantity 0
        const items = Object.values(state.cart).filter(i => i.qty > 0);
        const emptyMsg = state.lang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨Ø© ÙØ§Ø±ØºØ©.' : 'Cart is empty.';
        if(!root) return;

        if(items.length === 0){
            root.innerHTML = `<div class="muted" style="text-align:center;padding:20px 0;">${emptyMsg}</div>`;
            $('checkoutBtn').disabled = true;
            return;
        }
        $('checkoutBtn').disabled = false;

        root.innerHTML = items.map(item => {
            const name = item['name_' + state.lang];
            const subtotal = (item.price * item.qty).toFixed(2);
            
            const decreaseTitle = state.lang === 'ar' ? 'Ø¥Ù†Ù‚Ø§Øµ' : 'Decrease';
            const increaseTitle = state.lang === 'ar' ? 'Ø²ÙŠØ§Ø¯Ø©' : 'Increase';
            const removeTitle = state.lang === 'ar' ? 'Ø¥Ø²Ø§Ù„Ø©' : 'Remove';

            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.01);">
                <div>
                    <div style="font-weight:700;line-height:1.3;">${name}</div>
                    <small class="muted">${item.price} Pi x ${item.qty}</small>
                </div>
                <div style="text-align:right">
                    <div style="color:var(--pi-yellow);font-weight:700;">${subtotal} Pi</div>
                    <div style="display:flex;gap:4px;margin-top:4px;">
                        <button class="ghost cart-qty-btn" data-id="${item.id}" data-change="-1" title="${decreaseTitle}" style="padding:4px 8px;">-</button>
                        <button class="ghost cart-qty-btn" data-id="${item.id}" data-change="1" title="${increaseTitle}" style="padding:4px 8px;">+</button>
                        <button class="ghost cart-remove-btn" data-id="${item.id}" title="${removeTitle}" style="padding:4px 8px;"><i class="fa-solid fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');

        document.querySelectorAll('.cart-qty-btn').forEach(btn => btn.addEventListener('click', handleCartQtyChange));
        document.querySelectorAll('.cart-remove-btn').forEach(btn => btn.addEventListener('click', handleCartRemove));
    }

    function updateCartTotal(){
        const total = Object.values(state.cart).reduce((sum, item) => sum + (item.price * item.qty), 0).toFixed(2);
        const label = state.lang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:' : 'Total:';
        $('cartTotal').textContent = `${label} ${total} Pi`;
    }

    function handleCartQtyChange(e){
        const id = e.currentTarget.dataset.id;
        const change = parseInt(e.currentTarget.dataset.change, 10);
        if(state.cart[id]){
            state.cart[id].qty += change;
            if(state.cart[id].qty <= 0) delete state.cart[id];
            saveCart();
            renderCart();
            if(change > 0) toast(state.lang === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø©!' : 'Increased!', 800);
            else if (change < 0 && state.cart[id]) toast(state.lang === 'ar' ? 'ØªÙ… Ø§Ù„Ø¥Ù†Ù‚Ø§Øµ!' : 'Decreased!', 800);
            else toast(state.lang === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©!' : 'Removed!', 800);
        }
    }

    function handleCartRemove(e){
        const id = e.currentTarget.dataset.id;
        delete state.cart[id];
        saveCart();
        renderCart();
        toast(state.lang === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©!' : 'Removed!', 800);
    }

    // -------------------------
    // Pi SDK Mockup/Simulation (Simplified)
    // -------------------------

    function initPiSdk(){
        if(state.piLoaded) return;
        
        pageLog(state.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Pi SDK (Testnet)' : 'Simulating Pi SDK (Testnet)...');
        
        // Simulate loading the SDK
        state.piLoaded = true;
        state.pi = {
            auth: {
                
                // Simplified auth function (mocking Pi.auth.request)
                request: () => new Promise(resolve => {
                    pageLog(state.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„...' : 'Requesting Pi Auth...');
                    // Simulate success after a short delay
                    setTimeout(() => {
                        const mockUser = {
                            username: 'PiPioneerDemo',
                            uid: 'mock-uid-123456789',
                            level: 1 // Testnet
                        };
                        state.user = mockUser;
                        updateUserInfo();
                        pageLog(state.lang === 'ar' ? 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Pi PioneerDemo!' : 'Connected successfully with PiPioneerDemo!', 'info');
                        resolve({ user: mockUser });
                    }, 1000);
                })
            },
            payments: {
                // Simplified payments function (mocking Pi.payments.createPayment)
                createPayment: (paymentData) => new Promise(resolve => {
                    pageLog(`${state.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©' : 'Creating Payment'}: ${paymentData.amount} Pi...`);
                    setTimeout(() => {
                        pageLog(state.lang === 'ar' ? 'Ù†Ø¬Ø§Ø­ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¯ÙØ¹!' : 'Payment simulation successful!', 'info');
                        state.cart = {}; // Clear cart on successful payment simulation
                        saveCart();
                        renderCart();
                        resolve({ paymentId: 'mock-pi-tx-123', status: 'completed' });
                    }, 2000);
                })
            }
        };
        pageLog(state.lang === 'ar' ? 'Pi SDK Ø¬Ø§Ù‡Ø².' : 'Pi SDK Ready.', 'info');
    }

    function updateUserInfo() {
        const userText = state.user ? state.user.username : getTranslation(null, state.lang, 'disconnected');
        const balanceText = state.user ? '1234.56 Pi' : ''; // Mock balance
        $('userInfo').querySelector('.username-text').textContent = userText;
        $('userInfo').querySelector('.balance-text').textContent = balanceText;
        $('connectBtn').textContent = state.user ? state.user.username : getTranslation(null, state.lang, 'connectBtn');
    }

    function handleConnect() {
        if (state.user) {
            // Already connected, maybe show profile mock
            toast(state.lang === 'ar' ? `Ù…ØªØµÙ„ Ø¨Ø§Ø³Ù…: ${state.user.username}` : `Connected as: ${state.user.username}`);
            return;
        }
        
        if (!state.pi) {
            initPiSdk();
        }
        
        if (state.pi?.auth) {
            state.pi.auth.request(['username'])
                .catch(error => {
                    pageLog(`${state.lang === 'ar' ? 'Ø®Ø·Ø£ Ø§Ù„Ø§ØªØµØ§Ù„:' : 'Auth Error:'} ${error.message || error}`, 'error');
                });
        }
    }

    function handleCheckout(){
        if(!state.user){
            toast(state.lang === 'ar' ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.' : 'Please connect first.');
            return;
        }

        const totalAmount = Object.values(state.cart).reduce((sum, item) => sum + (item.price * item.qty), 0).toFixed(2);
        if(totalAmount <= 0) return;

        const memo = `Forsale order: ${state.session}`;
        const metadata = { cart: state.cart };

        const paymentData = {
            amount: totalAmount,
            memo: memo,
            metadata: metadata
        };

        state.pi.payments.createPayment(paymentData)
            .catch(error => {
                pageLog(`${state.lang === 'ar' ? 'Ø®Ø·Ø£ Ø§Ù„Ø¯ÙØ¹:' : 'Payment Error:'} ${error.message || error}`, 'error');
            });
    }
    
    // -------------------------
    // AI Mockup (Logy)
    // -------------------------
    

    function handleLogyChat(){
        const input = $('logyInput');
        const msg = input.value.trim();
        if(!msg) return;

        const chatBody = $('logyBody');
        const statusEl = $('logyStatus');

        // User Bubble
        chatBody.innerHTML += `<div class="chat-bubble user">${msg}</div>`;
        chatBody.scrollTop = chatBody.scrollHeight;
        input.value = '';
        
        statusEl.textContent = state.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'Processing...';

        // AI Mockup Response
        setTimeout(() => {
            let aiResponse = '';
            const lowerMsg = msg.toLowerCase();

            if(lowerMsg.includes(state.lang === 'ar' ? 'ØªÙˆØµÙŠØ©' : 'recommend')){
                aiResponse = state.lang === 'ar' ? 'Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø£ÙˆØµÙŠ Ø¨Ø¬Ù‡Ø§Ø² "Ù‡Ø§ØªÙ Pi Ø§Ù„Ø°ÙƒÙŠ" Ù„Ù…ÙŠØ²Ø§ØªÙ‡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©.' : 'Based on your history, I recommend the "Pi Smart Phone" for its advanced features.';
            } else if (lowerMsg.includes(state.lang === 'ar' ? 'ÙƒÙˆØ±ÙˆÙ„Ø§' : 'corolla')){
                aiResponse = state.lang === 'ar' ? 'ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§ 2018 Ù‡ÙŠ Ø³ÙŠØ§Ø±Ø© Ù…ÙˆØ«ÙˆÙ‚Ø© Ø¨ØªÙ‚ÙŠÙŠÙ… 4.3ØŒ Ù‡Ù„ ØªÙˆØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø¹Ø±Ø¨Ø©ØŸ' : 'The Toyota Corolla 2018 is a reliable car with a 4.3 rating. Would you like to add it to your cart?';
            } else {
                aiResponse = state.lang === 'ar' ? 'ÙÙ‡Ù…Øª Ø³Ø¤Ø§Ù„Ùƒ. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ.' : 'I understand your query. Searching for the best response to assist you.';
            }

            chatBody.innerHTML += `<div class="chat-bubble ai">${aiResponse}</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
            statusEl.textContent = state.lang === 'ar' ? 'Ø¬Ø§Ù‡Ø²' : 'Ready';
            pageLog(`${state.lang === 'ar' ? 'ØªÙØ§Ø¹Ù„ AI Ù†Ø§Ø¬Ø­' : 'AI interaction successful'}`, 'ai');
        }, 1500);
    }

    // -------------------------
    // Event Listeners & Initialization
    // -------------------------

    document.addEventListener('DOMContentLoaded', () => {
        // Set up initial language and render
        translatePage();
        renderCategories();
        renderProducts();
        updateUserInfo();
        
        // Load logs
        state.logs.reverse().forEach(log => {
            const el = $('txLog');
            if(!el) return;
            const div = document.createElement('div');
            div.innerHTML = `<small style="color:${log.level==='error'?'#FF6B6B': log.level === 'info' ? '#00FF7F' : '#9CA3AF'}">${log.ts}</small> ${log.text}`;
            el.appendChild(div);
        });
        
        // --- Bindings ---
        
        $('langToggleTop').addEventListener('click', () => {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('forsale_lang', state.lang);
            translatePage();
            toast(state.lang === 'ar' ? 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.' : 'Language changed.', 1000);
        });
        
        $('sortSelect').addEventListener('change', (e) => {
            const activeCat = $('cats')?.querySelector('.cat.active')?.dataset.cat || 'all';
            renderProducts(activeCat, e.target.value);
        });
        
        $('connectBtn').addEventListener('click', handleConnect);
        $('checkoutBtn').addEventListener('click', handleCheckout);
        $('logyBtn').addEventListener('click', () => $('logyModal').classList.add('show'));
        $('logySend').addEventListener('click', handleLogyChat);
        $('logyInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleLogyChat();
        });
        $('clearLogs').addEventListener('click', () => {
            state.logs = [];
            localStorage.removeItem('forsale_logs');
            $('txLog').innerHTML = '';
            toast(state.lang === 'ar' ? 'ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø¬Ù„' : 'Logs cleared', 800);
        });
        
        // Network Toggle (Testnet/Mainnet)
        $('netBtn').addEventListener('click', () => {
            state.mainnet = !state.mainnet;
            translatePage(); // Update button text
            const net = state.mainnet ? 'Mainnet' : 'Testnet';
            pageLog(`${state.lang === 'ar' ? 'ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰' : 'Switched to'} ${net}`, 'info');
        });

        // Modal close handlers (using event delegation for simplicity)
        document.querySelectorAll('.modal').forEach(modal => {
            const closeBtn = modal.querySelector('button[data-ar="Ø¥ØºÙ„Ø§Ù‚"]');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            }
            // Allow closing by clicking outside the box
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    modal.classList.remove('show');
                }
            });
        });

        // Close modals with escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Init Pi SDK simulation on load
        initPiSdk();
    });

})();
</script>
</body>
</html>
