<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forsale - Ù…Ù†ØµØ© Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Pi Hackathon)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© */
        body { font-family: 'Cairo', sans-serif; background-color: #1f2937; } /* bg-gray-800 */
        .product-card { min-height: 480px; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ù„Ø²Ø± AI */
        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
        }
        .ai-pulse { animation: pulse-yellow 2s infinite; }
        
        /* ØªØ®ØµÙŠØµ Ø§Ù„Ù€ scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #374151; } /* bg-gray-700 */
        ::-webkit-scrollbar-thumb { background: #fcd34d; border-radius: 10px; } /* yellow-400 */
        ::-webkit-scrollbar-thumb:hover { background: #facc15; } /* yellow-500 */
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <div id="message-box" class="fixed top-0 inset-x-0 z-50 p-4 hidden"></div>

    <header class="bg-gray-800 shadow-xl sticky top-0 z-40">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <h1 class="text-3xl font-black">
                <span class="text-green-400">For</span><span class="text-white">sale</span>
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                
                <button id="open-orders-btn" class="relative p-2 rounded-full bg-gray-700 hover:bg-yellow-500 hover:text-gray-900 transition" title="Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </button>
                
                <button id="open-cart-btn" class="relative p-2 rounded-full bg-yellow-500 text-gray-900 hover:bg-yellow-400 transition transform hover:scale-105" title="Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6">

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 text-sm text-gray-400">
            <p>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Pi/Firebase): <span id="pi-user-id" class="font-mono text-yellow-400 break-all">...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span></p>
        </div>

        <section class="mb-10 p-6 bg-gray-800 rounded-3xl shadow-2xl border-2 border-yellow-700">
            <h2 class="text-3xl font-extrabold text-yellow-500 mb-4 flex items-center">
                Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ (AI Marketplace Agent)
                <span class="mr-2 text-xl text-yellow-400">(Gemini 2.5 Mock)</span>
            </h2>
            <p class="text-gray-400 mb-4">ØµÙ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø¹Ø¨Ø± Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø«) Ø¨Ø§Ù‚ØªØ±Ø§Ø­ Ø£ÙØ¶Ù„ ØµÙÙ‚Ø© Ù„Ùƒ Ù…Ø³Ø¹Ù‘Ø±Ø© Ø¨Ø§Ù„Ù€ $\pi$ (Pi Coin).</p>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse">
                <input type="text" id="ai-search-input" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‚Ø© ØµØºÙŠØ±Ø© Ø¨Ù…ÙˆØ§ØµÙØ§Øª ØµØ¯ÙŠÙ‚Ø© Ù„Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø³Ø¹Ø± Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 500 $\pi$..." class="flex-grow p-3 rounded-xl bg-gray-700 border border-gray-600 text-white focus:ring-yellow-500 focus:border-yellow-500" dir="rtl">
                <button id="ai-search-button" class="ai-pulse bg-yellow-500 text-gray-900 font-extrabold py-3 px-8 rounded-xl shadow-xl hover:bg-yellow-400 transition duration-300">
                    Ø¨Ø­Ø« AI
                </button>
            </div>
            
            <div id="ai-search-results" class="mt-6">
                </div>
        </section>

        <section>
            <h2 class="text-3xl font-extrabold text-white mb-6">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹</h2>
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
        </section>
    </main>

    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen pt-12 p-4">
            <div class="bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-6 transform transition-all">
                <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                    <h3 class="text-3xl font-black text-white">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                    <button id="close-cart-btn" class="text-gray-400 hover:text-red-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div id="cart-content" class="max-h-96 overflow-y-auto pr-2">
                    </div>
                
                <p id="empty-cart-message" class="text-center text-gray-400 p-8 hidden">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©.</p>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-bold text-gray-300">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
                        <span class="text-4xl font-black text-yellow-500" dir="ltr">
                            <span id="cart-total">0.00</span> $\pi$
                        </span>
                    </div>
                    <button id="checkout-btn" class="w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-xl shadow-xl hover:bg-yellow-400 transition duration-300 disabled:opacity-50" disabled>
                        Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© Pi (Ù…Ø­Ø§ÙƒØ§Ø©)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen pt-12 p-4">
            <div class="bg-gray-900 border-4 border-green-600 rounded-3xl shadow-2xl w-full max-w-lg p-8 transform transition-all">
                <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-6">
                    <h3 class="text-3xl font-black text-green-500">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
                    <button id="close-checkout-btn" class="text-gray-400 hover:text-red-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="text-center p-6 bg-gray-800 rounded-xl mb-6">
                    <p class="text-gray-400 text-xl mb-2">Ø³ØªÙ‚ÙˆÙ… Ø¨Ø¯ÙØ¹:</p>
                    <p class="text-6xl font-black text-yellow-400" dir="ltr">
                        <span id="checkout-total-pi">0.00</span> $\pi$
                    </p>
                    <p class="text-gray-500 mt-2">Ù…Ù‚Ø§Ø¨Ù„ <span id="checkout-product-count" class="font-bold">0</span> Ù…Ù†ØªØ¬Ø§Øª.</p>
                </div>

                <p class="text-sm text-red-400 text-center p-3 bg-red-900/50 rounded-lg mb-6">
                    **Ù…Ù„Ø­ÙˆØ¸Ø©:** Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‡ÙŠ Ù…Ø­Ø§ÙƒØ§Ø© (Mock) Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù‡Ø§ÙƒØ«ÙˆÙ†. Ø¹Ù…Ù„ÙŠØ© ØªØ­ÙˆÙŠÙ„ $\pi$ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ØªØªØ·Ù„Ø¨ Ø¯Ù…Ø¬ Pi SDK.
                </p>

                <button id="confirm-checkout-btn" class="w-full bg-green-600 text-white font-extrabold py-4 rounded-xl shadow-2xl hover:bg-green-500 transition duration-300">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                </button>
            </div>
        </div>
    </div>

    <div id="orders-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen pt-12 p-4">
            <div class="bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-6 transform transition-all">
                <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                    <h3 class="text-3xl font-black text-yellow-500">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
                    <button id="close-orders-btn" class="text-gray-400 hover:text-red-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div id="orders-content" class="max-h-96 overflow-y-auto pr-2">
                    </div>
                <p id="empty-orders-message" class="text-center text-gray-400 p-8 hidden">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</p>
            </div>
        </div>
    </div>


    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, getDocs, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // **Ù…Ù„Ø§Ø­Ø¸Ø©:** ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Gemini AI Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ© ÙˆÙ„Ø£Ù†Ù‡Ø§ ØªØªØ·Ù„Ø¨ Ø®Ø§Ø¯Ù… ÙˆØ³ÙŠØ·.
        // Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙƒØ§Ø© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ø¯ÙŠ (Gemini's Search Tool).

        // ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙˆÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù€ Firebase
        setLogLevel('Debug');

        // **Ù…ØªØºÙŠØ±Ø§Øª Firestoe Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© - ÙŠØªÙ… ØªÙˆÙÙŠØ±Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙŠØ¦Ø© Pi App**
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // ----------------------------------------------------
        // 1. ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        // ----------------------------------------------------
        
        let db = null;
        let auth = null;
        let userId = null;
        let productsRef = null;
        let cartRef = null;
        let ordersRef = null; 
        let cartData = []; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firestore.");
                    document.getElementById('product-grid').innerHTML = '<div class="col-span-full text-center text-red-400 p-8">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©.</div>';
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Pi Network)
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø®Ø§Ø±Ø¬ Ø¨ÙŠØ¦Ø© Pi
                    await signInAnonymously(auth); 
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // ØªØ¹Ø±ÙŠÙ Ù…Ø³Ø§Ø±Ø§Øª Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ù„Ù€ Pi App)
                productsRef = collection(db, `/artifacts/${appId}/public/data/products`);
                cartRef = collection(db, `/artifacts/${appId}/users/${userId}/cart`);
                ordersRef = collection(db, `/artifacts/${appId}/users/${userId}/orders`); 

                console.log("Firebase Initialized. User ID:", userId);
                document.getElementById('pi-user-id').textContent = userId;
                
                // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                loadProducts();
                loadCart();
                loadOrders(); // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('product-grid').innerHTML = `<div class="col-span-full text-center text-red-400 p-8">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error.message}</div>`;
            }
        };

        // ----------------------------------------------------
        // 2. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
        // ----------------------------------------------------
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `fixed top-0 inset-x-0 z-50 p-4 text-center text-sm transition-all duration-300 ${isError ? 'bg-red-600 text-white shadow-lg' : 'bg-green-600 text-white shadow-lg'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 4000);
        }

        // ----------------------------------------------------
        // 3. Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        // ----------------------------------------------------
        const addInitialProducts = async () => {
             const initialProducts = [
                { name: 'Ø´Ù‚Ø© ÙØ§Ø®Ø±Ø© - Ø¯Ø¨ÙŠ', description: 'Ø­ØµØµ Ø±Ù‚Ù…ÙŠØ© Ù…Ù† Ø¹Ù‚Ø§Ø±Ø§Øª ÙØ§Ø®Ø±Ø© ÙÙŠ Ø¯Ø¨ÙŠ.', pricePi: 750.00, imageUrl: 'https://placehold.co/400x300/22c55e/ffffff?text=DUBAI', category: 'Real Estate' },
                { name: 'Ø³ÙŠØ§Ø±Ø© Tesla Model 3', description: 'Ø³ÙŠØ§Ø±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨ØªÙØ§ÙˆØ¶ AI.', pricePi: 500.00, imageUrl: 'https://placehold.co/400x300/3b82f6/ffffff?text=TESLA', category: 'Cars' },
                { name: 'MacBook Pro M3 Max', description: 'Ù„Ø§Ø¨ØªÙˆØ¨ Ø¨Ø£Ø¯Ø§Ø¡ Ø­Ø§Ø³ÙˆØ¨ÙŠ ÙØ§Ø¦Ù‚.', pricePi: 120.50, imageUrl: 'https://placehold.co/400x300/f97316/ffffff?text=MACBOOK', category: 'Electronics' },
                { name: 'Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø¬Ø²Ø± Ø§Ù„Ù…Ø§Ù„Ø¯ÙŠÙ', description: 'Ø±Ø­Ù„Ø© ÙØ§Ø®Ø±Ø© Ù„Ø´Ø®ØµÙŠÙ† Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù….', pricePi: 250.75, imageUrl: 'https://placehold.co/400x300/8b5cf6/ffffff?text=MALDIVES', category: 'Travel' },
                { name: 'Ø³Ø¨ÙŠÙƒØ© Ø°Ù‡Ø¨ Ø¹ÙŠØ§Ø± 24', description: 'Ø³Ø¨ÙŠÙƒØ© Ø°Ù‡Ø¨ Ø®Ø§Ù„ØµØ© Ø¨ÙˆØ²Ù† 10 Ø¬Ø±Ø§Ù….', pricePi: 45.99, imageUrl: 'https://placehold.co/400x300/ca8a04/ffffff?text=GOLD', category: 'Luxury' }
            ];

            const snapshot = await getDocs(productsRef);
            if (snapshot.empty) {
                for (const product of initialProducts) {
                    try {
                        const docId = product.name.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                        await setDoc(doc(productsRef, docId), { ...product, id: docId });
                    } catch (e) {
                        console.error(`Error adding initial product ${product.name}:`, e);
                    }
                }
            }
        };
        
        const loadProducts = () => {
            if (!productsRef) return;

            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '<div class="col-span-full text-center p-8"><span class="animate-spin h-8 w-8 border-4 border-yellow-500 border-t-transparent rounded-full inline-block"></span> <p class="mt-2 text-gray-400">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p></div>';

            onSnapshot(productsRef, (snapshot) => {
                productGrid.innerHTML = ''; 
                
                if (snapshot.empty) {
                    addInitialProducts(); // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                    return;
                }

                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                products.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                products.forEach(product => {
                    productGrid.appendChild(createProductCard(product));
                });
            }, (error) => {
                console.error("Error getting products: ", error);
                productGrid.innerHTML = '<div class="col-span-full text-center text-red-400 p-8">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</div>';
            });
        };

        // ----------------------------------------------------
        // 4. Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (UI)
        // ----------------------------------------------------
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = `product-card bg-gray-800 rounded-2xl shadow-2xl overflow-hidden transform transition duration-300 hover:scale-[1.02] cursor-pointer border-2 border-transparent hover:border-yellow-500`;
            
            let placeholderText = product.category || 'Product';
            if (product.name) {
                placeholderText = product.name.split(' ').slice(0, 2).join(' '); 
            }
            const imageUrl = product.imageUrl || `https://placehold.co/400x300/1f2937/fcd34d?text=${encodeURIComponent(placeholderText)}`;
            
            card.innerHTML = `
                <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover object-center" onerror="this.onerror=null;this.src='https://placehold.co/400x300/1f2937/fcd34d?text=${encodeURIComponent(product.category || 'ØµÙˆØ±Ø© Ù…ÙÙ‚ÙˆØ¯Ø©')}'">
                <div class="p-6">
                    <h3 class="text-2xl font-extrabold text-white mb-2">${product.name}</h3>
                    <p class="text-sm text-gray-400 h-12 overflow-hidden mb-4">${product.description}</p>
                    <div class="flex justify-between items-center mt-4">
                        <p class="text-xl font-black text-yellow-400">
                            ${parseFloat(product.pricePi).toFixed(2)} <span class="text-lg font-bold">Ï€</span>
                        </p>
                        <button class="add-to-cart-btn bg-yellow-500 text-gray-900 font-extrabold py-2 px-4 rounded-xl shadow-xl hover:bg-yellow-400 transition duration-200 text-sm transform hover:translate-y-[-2px]" data-product-id="${product.id}" data-name="${product.name}" data-price="${product.pricePi}">
                            + Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
                        </button>
                    </div>
                </div>
            `;
            
            card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                e.stopPropagation(); 
                addToCart(product.id, product.name, product.pricePi);
            });

            return card;
        }

        // ----------------------------------------------------
        // 5. Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Firestore Logic)
        // ----------------------------------------------------
        const addToCart = async (productId, name, pricePi) => {
            if (!cartRef) { showMessage('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª.', true); return; }

            try {
                const itemDocRef = doc(cartRef, productId);
                const itemSnap = await getDoc(itemDocRef);
                const numericPricePi = parseFloat(pricePi);

                if (isNaN(numericPricePi) || numericPricePi <= 0) {
                    showMessage('Ø®Ø·Ø£: Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ§Ù„Ø­.', true);
                    return;
                }

                if (itemSnap.exists()) {
                    const data = itemSnap.data();
                    const newQuantity = data.quantity + 1;
                    await updateDoc(itemDocRef, {
                        quantity: newQuantity,
                        totalPricePi: newQuantity * numericPricePi,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    await setDoc(itemDocRef, {
                        productId: productId,
                        name: name,
                        pricePi: numericPricePi,
                        quantity: 1,
                        totalPricePi: numericPricePi,
                        addedAt: new Date().toISOString()
                    });
                }

                showMessage(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©!`);
                
            } catch (e) {
                console.error("Error adding to cart: ", e);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©.', true);
            }
        };
        
        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø© (Ø²ÙŠØ§Ø¯Ø©/Ù†Ù‚ØµØ§Ù†/Ø­Ø°Ù)
        const updateCartItemQuantity = async (productId, delta) => {
            if (!cartRef) return;
            try {
                const itemDocRef = doc(cartRef, productId);
                const itemSnap = await getDoc(itemDocRef);
                if (itemSnap.exists()) {
                    const data = itemSnap.data();
                    const currentQuantity = data.quantity;
                    const numericPricePi = data.pricePi;
                    const newQuantity = currentQuantity + delta;
                    if (newQuantity <= 0) {
                        await deleteDoc(itemDocRef);
                        showMessage(`${data.name} ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø³Ù„Ø©.`);
                    } else {
                        await updateDoc(itemDocRef, {
                            quantity: newQuantity,
                            totalPricePi: newQuantity * numericPricePi,
                            updatedAt: new Date().toISOString()
                        });
                    }
                }
            } catch (e) {
                console.error("Error updating cart item quantity:", e);
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©.', true);
            }
        };

        const removeItemFromCart = async (productId, name) => {
            if (!cartRef) return;
            try {
                const itemDocRef = doc(cartRef, productId);
                await deleteDoc(itemDocRef);
                showMessage(`ØªÙ… Ø­Ø°Ù ${name} Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ù„Ø©.`);
            } catch (e) {
                console.error("Error removing item from cart:", e);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©.', true);
            }
        };


        // ----------------------------------------------------
        // 6. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (onSnapshot)
        // ----------------------------------------------------
        const loadCart = () => {
            if (!cartRef) return;
            const cartCountElement = document.getElementById('cart-count');
            const cartContentDiv = document.getElementById('cart-content');
            const cartTotalSpan = document.getElementById('cart-total');
            const checkoutButton = document.getElementById('checkout-btn');

            onSnapshot(cartRef, (snapshot) => {
                cartData = []; 
                let totalItems = 0;
                let totalPrice = 0;
                cartContentDiv.innerHTML = '';

                snapshot.docs.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    cartData.push(item);
                    totalItems += item.quantity || 0;
                    totalPrice += item.totalPricePi || 0;
                    cartContentDiv.appendChild(createCartItemElement(item));
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ UI
                cartCountElement.textContent = totalItems > 99 ? '99+' : totalItems;
                if (totalItems > 0) {
                    cartCountElement.classList.remove('hidden');
                    cartTotalSpan.textContent = totalPrice.toFixed(2);
                    checkoutButton.disabled = false;
                    document.getElementById('empty-cart-message').classList.add('hidden');
                } else {
                    cartCountElement.classList.add('hidden');
                    cartTotalSpan.textContent = '0.00';
                    checkoutButton.disabled = true;
                    document.getElementById('empty-cart-message').classList.remove('hidden');
                }

            }, (error) => {
                console.error("Error loading cart count:", error);
                cartCountElement.textContent = '0';
                cartCountElement.classList.add('hidden');
            });
        };
        
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ÙÙŠ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (UI)
        function createCartItemElement(item) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 bg-gray-700 rounded-xl mb-3 shadow-md border-r-4 border-yellow-500';
            div.innerHTML = `
                <div class="flex-grow ml-3">
                    <p class="text-white font-bold text-lg">${item.name}</p>
                    <p class="text-sm text-gray-300">${item.pricePi.toFixed(2)} $\pi$ / Ù„Ù„ÙˆØ­Ø¯Ø©</p>
                </div>
                <div class="flex items-center space-x-3 space-x-reverse">
                    <button class="qty-btn bg-red-600 hover:bg-red-500 text-white p-1 rounded-full w-6 h-6 flex items-center justify-center text-xl font-bold transition" data-id="${item.id}" data-delta="-1" title="ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"> âˆ’ </button>
                    <span class="text-white font-extrabold text-xl w-6 text-center">${item.quantity}</span>
                    <button class="qty-btn bg-green-600 hover:bg-green-500 text-white p-1 rounded-full w-6 h-6 flex items-center justify-center text-xl font-bold transition" data-id="${item.id}" data-delta="1" title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"> + </button>
                </div>
                <div class="ml-4 text-left">
                    <p class="text-xl font-black text-yellow-400">${item.totalPricePi.toFixed(2)} $\pi$</p>
                </div>
                <button class="remove-btn text-gray-400 hover:text-red-500 transition mr-2" data-id="${item.id}" data-name="${item.name}" title="Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            `;
            
            div.querySelectorAll('.qty-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    const delta = parseInt(e.currentTarget.getAttribute('data-delta'));
                    updateCartItemQuantity(productId, delta);
                });
            });

            div.querySelector('.remove-btn').addEventListener('click', (e) => {
                const productId = e.currentTarget.getAttribute('data-id');
                const name = e.currentTarget.getAttribute('data-name');
                removeItemFromCart(productId, name);
            });

            return div;
        }

        // ----------------------------------------------------
        // 7. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ (Ù…Ø­Ø§ÙƒØ§Ø© Pi Checkout)
        // ----------------------------------------------------
        const handlePiCheckout = async () => {
            if (cartData.length === 0 || !ordersRef || !cartRef) {
                showMessage("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©.", true);
                return;
            }

            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const confirmBtn = document.getElementById('confirm-checkout-btn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="animate-spin h-5 w-5 border-4 border-t-transparent border-white rounded-full inline-block ml-2"></span> Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...';
            
            const totalAmount = cartData.reduce((sum, item) => sum + (item.totalPricePi || 0), 0);

            try {
                // ** [Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù‡Ø§ÙƒØ«ÙˆÙ†] **: Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ ÙÙŠÙ‡ Ø¯Ù…Ø¬ Pi SDK
                showMessage(`Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ ${totalAmount.toFixed(2)} $\pi$ ... (Ù…Ø­Ø§ÙƒØ§Ø©)`, false);
                await new Promise(resolve => setTimeout(resolve, 3000)); // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±
                // ** [Ù†Ù‡Ø§ÙŠØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù‡Ø§ÙƒØ«ÙˆÙ†] **

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firestore
                const orderPayload = {
                    userId: userId,
                    totalPi: totalAmount,
                    items: cartData.map(item => ({
                        productId: item.productId,
                        name: item.name,
                        quantity: item.quantity,
                        unitPricePi: item.pricePi,
                        totalPricePi: item.totalPricePi
                    })),
                    status: 'Processing', 
                    createdAt: new Date().toISOString()
                };
                await addDoc(ordersRef, orderPayload);
                
                // ØªÙØ±ÙŠØº Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Batch Write (ÙØ¹Ø§Ù„ ÙˆÙ…Ø¶Ù…ÙˆÙ†)
                const batch = writeBatch(db);
                const cartSnapshot = await getDocs(cartRef);
                cartSnapshot.docs.forEach((docItem) => {
                    batch.delete(docItem.ref);
                });
                await batch.commit();

                hideCheckoutModal();
                showMessage(`ğŸ‰ Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ Ù†Ø§Ø¬Ø­Ø©! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù€ ${totalAmount.toFixed(2)} $\pi$.`, false);

            } catch (error) {
                console.error("Checkout Failed:", error);
                showMessage("ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        };

        // ----------------------------------------------------
        // 8. ÙˆØ¸Ø§Ø¦Ù Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Orders History) (ØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§)
        // ----------------------------------------------------
        
        function formatDate(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'});
            } catch (e) {
                return isoString;
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§)
        function createOrderItemElement(order) {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 rounded-xl shadow-xl p-4 mb-3 border-r-4 border-green-500';
            
            const itemsList = order.items.map(item => `<li class="text-sm text-gray-300 mr-2">${item.name} (Ã—${item.quantity}) - ${item.unitPricePi.toFixed(2)} $\pi$</li>`).join('');

            div.innerHTML = `
                <div class="flex justify-between items-start border-b border-gray-600 pb-2 mb-2">
                    <p class="text-lg font-bold text-white">Ø§Ù„Ø·Ù„Ø¨ #${order.id.substring(0, 8)}</p>
                    <p class="text-sm font-semibold ${order.status === 'Processing' ? 'text-yellow-400' : 'text-green-400'}">${order.status}</p>
                </div>
                <div class="text-sm text-gray-400 mb-2">
                    <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formatDate(order.createdAt)}</p>
                    <p class="mt-1">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</p>
                    <ul class="list-disc pr-8">${itemsList}</ul>
                </div>
                <p class="text-right text-3xl font-black text-yellow-500 mt-3" dir="ltr">
                    ${order.totalPi.toFixed(2)} $\pi$
                </p>
            `;
            return div;
        }
        
        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§)
        const loadOrders = () => {
            if (!ordersRef) return;
            const ordersContentDiv = document.getElementById('orders-content');
            const emptyOrdersMessage = document.getElementById('empty-orders-message');

            const q = query(ordersRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                ordersContentDiv.innerHTML = '';
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (orders.length > 0) {
                    emptyOrdersMessage.classList.add('hidden');
                    orders.forEach(order => {
                        ordersContentDiv.appendChild(createOrderItemElement(order));
                    });
                } else {
                    emptyOrdersMessage.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error loading orders:", error);
                ordersContentDiv.innerHTML = '<p class="text-center text-red-400 p-8">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>';
                emptyOrdersMessage.classList.add('hidden');
            });
        };

        // ----------------------------------------------------
        // 9. Ø¯Ø§Ù„Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ø¯ÙŠ)
        // ----------------------------------------------------
        
        function createAISuggestionCard(result) {
            const card = document.createElement('div');
            card.className = `bg-gray-700 p-4 rounded-xl shadow-lg mb-4 border-l-4 border-yellow-500`;
            card.innerHTML = `
                <h4 class="text-xl font-bold text-yellow-400 mb-1">Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ù† AI: ${result.name}</h4>
                <p class="text-gray-300 mb-2">${result.description}</p>
                <p class="text-2xl font-black text-green-400">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${result.pricePi.toFixed(2)} $\pi$</p>
                <button class="add-to-cart-ai-btn bg-yellow-500 text-gray-900 font-extrabold py-2 px-4 rounded-xl shadow-xl hover:bg-yellow-400 transition duration-200 mt-3 text-sm" 
                    data-name="${result.name}" data-price="${result.pricePi}" data-id="${result.id}">
                    + Ø¥Ø¶Ø§ÙØ© ÙƒÙ…Ù†ØªØ¬ Ù…Ø®ØµØµ
                </button>
            `;
            card.querySelector('.add-to-cart-ai-btn').addEventListener('click', (e) => {
                const name = e.currentTarget.getAttribute('data-name');
                const price = e.currentTarget.getAttribute('data-price');
                const id = e.currentTarget.getAttribute('data-id');
                // Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù‘Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ø¤Ù‚Øª Ù„Ù…Ù†ØªØ¬ AI ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
                addToCart(`ai_custom_${id}`, name, price); 
                document.getElementById('ai-search-results').innerHTML = '';
            });
            return card;
        }

        async function aiSearchSimulation(queryText) {
            const resultsDiv = document.getElementById('ai-search-results');
            const searchButton = document.getElementById('ai-search-button');

            if (!queryText.trim()) {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ.", true);
                return;
            }

            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            searchButton.disabled = true;
            const originalButtonText = searchButton.innerHTML;
            searchButton.innerHTML = '<span class="animate-spin h-5 w-5 border-4 border-t-transparent border-white rounded-full inline-block ml-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            resultsDiv.innerHTML = '';
            
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ø¯ÙŠ)
                const searchResults = await google.search({ queries: [`${queryText} price in pi coin`] });
                
                // Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini Ù„ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ù†ØªØ¬
                const mockResponse = {
                    name: `ØµÙÙ‚Ø© AI Ù„Ù€: ${queryText.substring(0, 30)}...`,
                    description: `Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ Ø¨Ø­Ø« Ø§Ù„ÙˆÙŠØ¨ØŒ ÙŠÙˆØµÙŠ AI Ø¨ØµÙÙ‚Ø© Ù…Ø®ØµØµØ© Ù„Ùƒ. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.`,
                    pricePi: Math.floor(Math.random() * (700 - 50 + 1) + 50) + Math.round(Math.random() * 100) / 100, // Ø³Ø¹Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† 50 Ùˆ 700
                    id: Date.now()
                };
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
                resultsDiv.appendChild(createAISuggestionCard(mockResponse));
                showMessage("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù‚ØªØ±Ø§Ø­ AI.", false);

            } catch (error) {
                console.error("AI Search Simulation failed:", error);
                resultsDiv.innerHTML = '<p class="text-red-400 p-4">ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ. Ø±Ø¨Ù…Ø§ Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù…ÙØªØ§Ø­ API Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.</p>';
            } finally {
                searchButton.disabled = false;
                searchButton.innerHTML = originalButtonText;
            }
        }

        // ----------------------------------------------------
        // 10. ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (UI Logic)
        // ----------------------------------------------------
        
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div.transform').classList.remove('scale-0'), 10);
            } else {
                modal.classList.add('hidden');
                modal.querySelector('div.transform').classList.add('scale-0');
            }
        }

        function showCartModal() {
            toggleModal('cart-modal', true);
        }
        function hideCartModal() {
            toggleModal('cart-modal', false);
        }

        function showCheckoutModal() {
            const total = document.getElementById('cart-total').textContent;
            const count = cartData.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('checkout-total-pi').textContent = total;
            document.getElementById('checkout-product-count').textContent = count;
            
            hideCartModal();
            toggleModal('checkout-modal', true);
        }
        function hideCheckoutModal() {
            toggleModal('checkout-modal', false);
        }
        
        function showOrdersModal() {
            toggleModal('orders-modal', true);
        }
        function hideOrdersModal() {
            toggleModal('orders-modal', false);
        }


        // ----------------------------------------------------
        // 11. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners)
        // ----------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            // Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            document.getElementById('open-cart-btn').addEventListener('click', showCartModal);
            document.getElementById('close-cart-btn').addEventListener('click', hideCartModal);
            
            // Ø§Ù„Ø¯ÙØ¹
            document.getElementById('checkout-btn').addEventListener('click', showCheckoutModal);
            document.getElementById('close-checkout-btn').addEventListener('click', hideCheckoutModal);
            document.getElementById('confirm-checkout-btn').addEventListener('click', handlePiCheckout);

            // Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            document.getElementById('open-orders-btn').addEventListener('click', showOrdersModal);
            document.getElementById('close-orders-btn').addEventListener('click', hideOrdersModal);

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
            document.getElementById('ai-search-button').addEventListener('click', () => {
                const queryText = document.getElementById('ai-search-input').value;
                aiSearchSimulation(queryText);
            });
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.getElementById('cart-modal').addEventListener('click', (e) => {
                if (e.target.id === 'cart-modal') hideCartModal();
            });
            document.getElementById('checkout-modal').addEventListener('click', (e) => {
                if (e.target.id === 'checkout-modal') hideCheckoutModal();
            });
            document.getElementById('orders-modal').addEventListener('click', (e) => {
                if (e.target.id === 'orders-modal') hideOrdersModal();
            });
        });
    </script>
</body>
</html>
